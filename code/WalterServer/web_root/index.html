<!DOCTYPE HTML>
<html>
  <head>
    <script src="webix.js" type="text/javascript"></script>  
    <link href="skins/web.css" rel="stylesheet" type="text/css">
  </head>

  <body>
    <div align="center" id="htmlContainer"></div>
    <script type="text/javascript" charset="utf-8">

    // Webix declaration of widgets 
    webix.ready(function(){
      grida = webix.ui({
      container:"htmlContainer",
      type:"line",
      view:"layout",
      maxWidth:1400,
      rows: [
            // title and heartbeat 
            {view:"toolbar", 
             elements:[
                    { view:"label",id:"title",          label:"<big>W A L T E R S &nbsp;&nbsp;C E R E B E L L U M</big>", align:"center"},
                    { view:"icon", id:"heartbeat-on",   label:"heartbeat",          type:"iconButton", icon:"heart",   hidden:false },
                    { view:"icon", id:"heartbeat-off",  label:"heartbeat",          type:"iconButton", icon:"heart-o", hidden:true }
                  ]
            },

            // left windows with command history, right window with log file viewer
            { cols:[ 
                { view:"form", elements:[            
                    { view:"label",  label:"Cortex Command Log", align:"center"},
                    { view:"datatable", autoconfig:true, columns:[
                        { id:"time",   header:"Time", width:100},
                        { id:"traj",   header:"Trajectory", width:180},
                        { id:"line",   header:"Cortex", width:350}
                    ], datatype:"json", id:"cortexcmd", label:"Cortex Command", labelPosition:"top", value:"<no value>", url:"web?key=cortexcmd" }
                  ]},
                  { view:"form", elements:[            
                    { view:"label",  label:"Debug Log", align:"center"},
                    { view:"datatable", autoconfig:true, columns:[
                          { id:"time",   header:"Time", width:100},
                          { id:"line",   header:"Line", width:700}
                      ], datatype:"json", id:"cortexlog", label:"Cortex Log", labelPosition:"top",  value:"<no value>", url:"web?key=cortexlog"}
                  ], height:300 }
            ]}, 

            // cortex command line interface
            { height:10},
            { view:"text", id:"cortexcmdid", type:"form", label:"<b>CORTEX></b>", labelWidth:90, placeholder:"Key in cortex command. H for help.", 
                      on:{'onKeyPress': function(id){ 
                                          if (id==13) {
                                            webix.ajax().get("/web?action=savecmd&value=" + $$('cortexcmdid').getValue());
                                            $$('cortexcmdid').setValue('');
                                            $$('cortexcmd').load("web?key=cortexcmd&from=" + $$('cortexcmd').getLastId());
                                          }
                                        }
                        }
                  },

            // Walters status line
            { height:10},
            { view:"label", id:"botisuplabel" , label:"<b>Walter is off<b>", align:"Center"},
            { height:10},

            // left column has a input field for cortex command, right column has help textes
            { cols:[
              { view:"form", elements:[
                  { view:"slider", label:"Gripper", value:"0", min:0,     max: 100, name:"Gripper",   title:webix.template("#value#")},
                  { view:"slider", label:"Wrist",   value:"0", min:-180,  max: 180, name:"wrist",     title:webix.template("#value#")},
                  { view:"slider", label:"Forearm", value:"0", min:-180,  max: 180, name:"Forearm",   title:webix.template("#value#")},
                  { view:"slider", label:"Elbow",   value:"0", min:-180,  max: 180, name:"Elbow",     title:webix.template("#value#")},
                  { view:"slider", label:"Upperarm",value:"0", min:-180,  max: 180, name:"Upperarm",  title:webix.template("#value#")},
                  { view:"slider", label:"Hip",     value:"0", min:-180,  max: 180, name:"Hip",       title:webix.template("#value#")}
              ]},
              { view:"form", elements:[
                  { view:"toolbar",  elements:[
                    { view:"button", id:"startupbutton",  label:"Startup", type:"iconButton", icon:"chevron-up", align:"right",
                        on:{'OnItemClick': function(id){
                            $$("botisuplabel").define({ label:"<b>Walter is awaking</b>" }); 
                            $$("botisuplabel").refresh();
                            webix.ajax().get("/executor/startupbot"); 
                    }}},
                    { view:"button", id:"teardownbutton", label:"Teardown", type:"iconButton", icon:"chevron-down",  align:"right", hidden:"true",
                        on:{'OnItemClick': function(id){ 
                            $$("botisuplabel").define({ label:"<b>Walter is dying</b>" }); 
                            $$("botisuplabel").refresh();
                            webix.ajax().get("/executor/teardownbot"); 
                    }}},
                    { view:"button", id:"nullpositionbutton", label:"Nullposition", type:"iconButton", icon:"arrows-alt", disabled:"true",
                        on:{'OnItemClick': function(id){ webix.ajax().get("/executor/nullpositionbot"); }}},
                    ]
                  },
                  { view:"toolbar",  elements:[
                    { view:"button", id:"emergencystopbutton",  label:"Emergency Stop", type:"danger", icon:"power-off",
                        on:{'OnItemClick': function(id){ webix.ajax().get("/executor/emergencystop"); }}}
                    ]
                  }
              ]}
            ]}
          ]
      });
    });


    // find the id of the latest alert. Only newer alerts are displayed
    var alertFromId = 0; 
    webix.ajax("web?key=alert", function(text){ alertFromId = Number(text); });

    // heartbeat is set to 1 whenever the server reports a successful call 
    // it is reset via a 1s timer. The heartbeat icon on the header is set accordingly
    var heartbeatOn = 1;

    setInterval(function() {   

        // focus is always on input field
        $$('cortexcmdid').focus(); 

        // check for pending alerts
        webix.ajax().get("/web?key=alert&from="+alertFromId, 
          function(text){ 
            if (text != "") {
                webix.message({title:"Alert", type:'error', text:text, expire:10000 });
                alertFromId = Number(alertFromId)+1;
            }
          }
        );

        // update log view
        $$('cortexlog').load("web?key=cortexlog&from=" + $$('cortexlog').getLastId());

        // check server if a sucessful call to cortex happened
        if (heartbeatOn == 1) {
          $$('heartbeat-on').hide();
          $$('heartbeat-off').show();
          heartbeatOn = 0;
        } else {
          webix.ajax().get("/web?key=heartbeat", 
          function(text){ 
            if (text != "")  {
              heartbeatOn = 1;
              $$('heartbeat-on').show();
              $$('heartbeat-off').hide();
            }
          });
        };

        webix.ajax().get("/executor/isupandrunning",  function(text){ 
          if (text == "true") {
            $$('startupbutton').hide(); 
            $$('teardownbutton').show(); 
            $$('nullpositionbutton').enable(); 
            $$('botisuplabel').define({ label: "<b>Walter is up</b>" });
          } 
          if (text == "false") {
            $$('startupbutton').show(); 
            $$('teardownbutton').hide(); 
            $$('nullpositionbutton').disable(); 
            $$('botisuplabel').define({ label: "<b>Walter is off</b>" });
          }
          $$("botisuplabel").refresh();
 
        });
      },  2000);
    </script>
  </body>
</html>